<!doctype html>
<html lang="en">
  <head><script src="/tech/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=tech/livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Liste - http://localhost:1313/tech/">
    
      <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)']]                  
    }
  };
</script>
    
    <title>Test the Validity of a Factor | DafuZhu</title>
    <meta name="description" content="">
    <meta property="og:url" content="http://localhost:1313/tech/posts/cisc-factortest_3/">
  <meta property="og:site_name" content="DafuZhu">
  <meta property="og:title" content="Test the Validity of a Factor">
  <meta property="og:description" content="This project reproduced the factor validity test part in a report that focuses on the information of heavy stocks under the fund selection, and how to use the data of heavy stocks of the preferred fund to build a stable investment portfolio.
Rank IC test If a factor has a predictive effect on the expected return of the stock, there will be a certain correlation between the factor value of the stock in the current period and the return of the stock in the next period.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-02T02:29:56+08:00">
    <meta property="article:modified_time" content="2024-02-02T02:29:56+08:00">
    <meta property="article:tag" content="Intern">
    <meta property="article:tag" content="Cisc">
    <meta property="article:tag" content="2024">
    <meta property="article:tag" content="Factor">

    
  <meta itemprop="name" content="Test the Validity of a Factor">
  <meta itemprop="description" content="This project reproduced the factor validity test part in a report that focuses on the information of heavy stocks under the fund selection, and how to use the data of heavy stocks of the preferred fund to build a stable investment portfolio.
Rank IC test If a factor has a predictive effect on the expected return of the stock, there will be a certain correlation between the factor value of the stock in the current period and the return of the stock in the next period.">
  <meta itemprop="datePublished" content="2024-02-02T02:29:56+08:00">
  <meta itemprop="dateModified" content="2024-02-02T02:29:56+08:00">
  <meta itemprop="wordCount" content="1155">
  <meta itemprop="keywords" content="Intern,Cisc,2024,Factor">
    
  


    
    <link rel="canonical" href="http://localhost:1313/tech/posts/cisc-factortest_3/">
    <link rel="icon" href="http://localhost:1313/tech//assets/favicon.ico">
    <link rel="dns-prefetch" href="https://www.google-analytics.com">
    <link href="https://www.google-analytics.com" rel="preconnect" crossorigin>
    <link rel="alternate" type="application/atom+xml" title="DafuZhu" href="http://localhost:1313/tech//atom.xml" />
    <link rel="alternate" type="application/json" title="DafuZhu" href="http://localhost:1313/tech//feed.json" />
    <link rel="shortcut icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNk+A8AAQUBAScY42YAAAAASUVORK5CYII=">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Bricolage+Grotesque">
    <link rel="stylesheet" href="/css/syntax.css">
    
    
    <style>*,:after,:before{box-sizing:border-box;padding:0}body{font:1rem/1.5 bricolage grotesque,-apple-system,BlinkMacSystemFont,segoe ui,Helvetica,Arial,sans-serif;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;padding:2rem;background:#fffdfa;color:#000}.skip-link{position:absolute;top:-40px;left:0;background:#eee;z-index:100}.skip-link:focus{top:0}header{line-height:2;padding-bottom:1.5rem}.link{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-decoration:none}.time{font-variant-numeric:tabular-nums;white-space:nowrap}blockquote{border-left:5px solid #eee;padding-left:1rem;margin:0}a,a:visited{color:inherit}a:hover,a.heading-link{text-decoration:none}pre{padding:.5rem;overflow:auto;overflow-x:scroll;overflow-wrap:normal}code,pre{font-family:San Francisco Mono,Monaco,consolas,lucida console,dejavu sans mono,bitstream vera sans mono,monospace;font-size:normal;font-size:small;background:#eee}code{margin:.1rem;border:none}ul{list-style-type:square}ul,ol{padding-left:1.2rem}.list{line-height:2;list-style-type:none;padding-left:0}.list li{padding-bottom:.1rem}.meta{color:#777}.content{max-width:70ch;margin:0 auto}header{line-height:2;display:flex;justify-content:space-between;padding-bottom:1rem}header a{text-decoration:none}header ul{list-style-type:none;padding:0}header li,header a{display:inline}h2.post{padding-top:.5rem}header ul a:first-child{padding-left:1rem}.nav{height:1px;background:#000;content:'';max-width:10%}.list li{display:flex;align-items:baseline}.list li time{flex:initial}.hr-list{margin-top:0;margin-bottom:0;margin-right:.5rem;margin-left:.5rem;height:1px;border:0;border-bottom:1px dotted #ccc;flex:1 0 1rem}.m,hr{border:0;margin:3rem 0}img{max-width:100%;height:auto}.post-date{margin:5% 0}.index-date{color:#9a9a9a}.animate-blink{animation:opacity 1s infinite;opacity:1}@keyframes opacity{0%{opacity:1}50%{opacity:.5}100%{opacity:0}}.tags{display:flex;justify-content:space-between}.tags ul{padding:0;margin:0}.tags li{display:inline}.avatar{height:120px;width:120px;position:relative;margin:-10px 0 0 15px;float:right;border-radius:50%}table{width:100%;border-collapse:collapse}th,td{border:1px solid #ddd;text-align:left;padding:8px}th{background-color:#f2f2f2} </style>
  
    
  
  
  <script type="application/ld+json">
  {
      "@context": "http://schema.org",
      "@type": "BlogPosting",
      "articleSection": "posts",
      "name": "Test the Validity of a Factor",
      "headline": "Test the Validity of a Factor",
      "alternativeHeadline": "",
      "description": "This project reproduced the factor validity test part in a report that focuses on the information of heavy stocks under the fund selection, and how to use the data of heavy stocks of the preferred fund to build a stable investment portfolio.\nRank IC test If a factor has a predictive effect on the expected return of the stock, there will be a certain correlation between the factor value of the stock in the current period and the return of the stock in the next period.",
      "inLanguage": "en-us",
      "isFamilyFriendly": "true",
      "mainEntityOfPage": {
          "@type": "WebPage",
          "@id": "http:\/\/localhost:1313\/tech\/posts\/cisc-factortest_3\/"
      },
      "author" : {
          "@type": "Person",
          "name": ""
      },
      "creator" : {
          "@type": "Person",
          "name": ""
      },
      "accountablePerson" : {
          "@type": "Person",
          "name": ""
      },
      "copyrightHolder" : "DafuZhu",
      "copyrightYear" : "2024",
      "dateCreated": "2024-02-02T02:29:56.00Z",
      "datePublished": "2024-02-02T02:29:56.00Z",
      "dateModified": "2024-02-02T02:29:56.00Z",
      "publisher":{
          "@type":"Organization",
          "name": "DafuZhu",
          "url": "http://localhost:1313/tech/",
          "logo": {
              "@type": "ImageObject",
              "url": "http:\/\/localhost:1313\/tech\/",
              "width":"32",
              "height":"32"
          }
      },
      "image": "http://localhost:1313/tech/",
      "url" : "http:\/\/localhost:1313\/tech\/posts\/cisc-factortest_3\/",
      "wordCount" : "1155",
      "genre" : [ "intern" , "cisc" , "2024" , "factor" ],
      "keywords" : [ "intern" , "cisc" , "2024" , "factor" ]
  }
  </script>
  
</head>

<body>
  <a class="skip-link" href="#main">Skip to main</a>
  <main id="main">
  <div class="content">
    <header>
<p style="padding: 0;margin: 0;">
  <a href="http://localhost:1313/tech/">
    <b>DafuZhu</b>
    <span class="text-stone-500 animate-blink">â–®</span>
  </a>
</p>
<ul style="padding: 0;margin: 0;">
  
  
  <li class="">
    <a href="/tech/posts/"><span>Post</span></a>
    
  <li class="">
    <a href="/tech/about/"><span>About</span></a>
    
  </li>
</ul>
</header>
<hr class="hr-list" style="padding: 0;margin: 0;">
    <section>
      <h2 class="post">Test the Validity of a Factor</h2>
      <p>This project reproduced the factor validity test part in a report that focuses on the information of heavy stocks under the fund selection, and how to use the data of heavy stocks of the preferred fund to build a stable investment portfolio.</p>
<h3 id="rank-ic-test">Rank IC test</h3>
<p>If a factor has a predictive effect on the expected return of the stock, there will be a certain correlation between the factor value of the stock in the current period and the return of the stock in the next period. If we use the Pearson linear correlation coefficient between the two, then the presence of certain outliers may greatly affect the results. Therefore, we will use the more robust Spearman rank correlation coefficient to measure the validity of factors.</p>
<p>As shown in the figure below, the ranking sequence A is obtained by sorting all stocks according to the factor value of the current period, and the ranking sequence B is obtained by sorting all stocks according to the return of the next period. The larger the absolute value of Rank IC is, the stronger the predictive power of this factor for stock returns is. Generally, we will count the mean, standard deviation and t-statistics of Rank IC in the sample interval to analyze the performance of factors from multiple perspectives such as significance and stability of predictive ability.</p>
<p><img
  src="/img/cisc_3_1.png"
  alt="fig1"
  loading="lazy"
  decoding="async"
  class="full-width"
/>

</p>
<p>For stock \(i\) (where \(i=1, \cdots, n\)), denote the <strong>ranks</strong> of the current factor values of stocks as \(f_1, \cdots, f_n\), the <strong>ranks</strong> of the returns of the next period as \(r_1, \cdots, r_n\).</p>
$$
\text{RankIC}(f)=corr(A,B)=\frac{cov(\mathbf{A},\mathbf{B})}{\sqrt{var(\mathbf{A})\cdot var(\mathbf{B})}}
$$<p>where</p>
$$
\mathbf{A}=\begin{bmatrix}
f_1\\
f_2\\
\vdots\\
f_n
\end{bmatrix},\quad
\mathbf{B}=\begin{bmatrix}
r_1\\
r_2\\
\vdots\\
r_n
\end{bmatrix}
$$<p>This process can be programmed following the steps.</p>
<p><strong>Step 1: Create a folder with a structure as below</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>folder
</span></span><span style="display:flex;"><span>â”œâ”€â”€ data
</span></span><span style="display:flex;"><span>â”‚   â”œâ”€â”€ factors
</span></span><span style="display:flex;"><span>â”‚   â””â”€â”€ return
</span></span><span style="display:flex;"><span>â””â”€â”€ main
</span></span></code></pre></div><p><strong>Step 2: Add raw data into the &ldquo;data&rdquo; folder</strong></p>
<ul>
<li>factors:
<ul>
<li><a href="/raw_data/cisc_3(institute_prop).csv">Institute holding proportion</a></li>
<li><a href="/raw_data/cisc_3(select_ability).csv">Security selecting ability.</a></li>
<li><a href="/raw_data/cisc_3(fund_share).csv">Fund share</a></li>
<li><a href="/raw_data/cisc_3(annual_return).csv">Recent annual return</a></li>
<li><a href="/raw_data/cisc_3(max_drawdown).csv">Max drawdown</a></li>
</ul>
</li>
<li>return: <a href="/raw_data/cisc_3(net_value).csv">Fund&rsquo;s net value</a></li>
</ul>
<p><strong>Step 3: Create a <code>main.py</code> file under the &ldquo;main&rdquo; folder, with the code below</strong></p>
<p>Remind that the working directory should be the root folder when running this program.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">pandas</span> <span style="color:#00a8c8">as</span> <span style="color:#111">pd</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">numpy</span> <span style="color:#00a8c8">as</span> <span style="color:#111">np</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">os</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">math</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">scipy.stats</span> <span style="color:#00a8c8">as</span> <span style="color:#111">stats</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> <span style="color:#111">scipy.stats</span> <span style="color:#f92672">import</span> <span style="color:#111">norm</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">matplotlib.pyplot</span> <span style="color:#00a8c8">as</span> <span style="color:#111">plt</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">matplotlib.dates</span> <span style="color:#00a8c8">as</span> <span style="color:#111">mdates</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">matplotlib</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> <span style="color:#111">datetime</span> <span style="color:#f92672">import</span> <span style="color:#111">datetime</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">factor_path</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#39;data/factors/&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">return_path</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#39;data/return/&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#111">result_dir</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#39;result/&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">if</span> <span style="color:#f92672">not</span> <span style="color:#111">os</span><span style="color:#f92672">.</span><span style="color:#111">path</span><span style="color:#f92672">.</span><span style="color:#111">exists</span><span style="color:#111">(</span><span style="color:#111">result_dir</span><span style="color:#111">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">os</span><span style="color:#f92672">.</span><span style="color:#111">mkdir</span><span style="color:#111">(</span><span style="color:#111">result_dir</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">def</span> <span style="color:#75af00">get_fund_return</span><span style="color:#111">(</span><span style="color:#111">n</span><span style="color:#111">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Return rate of the next n terms</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">df</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">read_csv</span><span style="color:#111">(</span><span style="color:#111">os</span><span style="color:#f92672">.</span><span style="color:#111">path</span><span style="color:#f92672">.</span><span style="color:#111">join</span><span style="color:#111">(</span><span style="color:#111">return_path</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;cisc_3(net_value).csv&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">df</span> <span style="color:#f92672">=</span> <span style="color:#111">df</span><span style="color:#f92672">.</span><span style="color:#111">rename</span><span style="color:#111">(</span><span style="color:#111">columns</span><span style="color:#f92672">=</span><span style="color:#111">{</span><span style="color:#d88200">&#39;Unnamed: 0&#39;</span><span style="color:#111">:</span> <span style="color:#d88200">&#39;Date&#39;</span><span style="color:#111">})</span><span style="color:#f92672">.</span><span style="color:#111">set_index</span><span style="color:#111">(</span><span style="color:#d88200">&#39;Date&#39;</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">fillna</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">float</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">fund_value</span> <span style="color:#f92672">=</span> <span style="color:#111">df</span><span style="color:#f92672">.</span><span style="color:#111">copy</span><span style="color:#111">()</span><span style="color:#f92672">.</span><span style="color:#111">shift</span><span style="color:#111">(</span><span style="color:#111">n</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">fund_value_future</span> <span style="color:#f92672">=</span> <span style="color:#111">df</span><span style="color:#f92672">.</span><span style="color:#111">copy</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">date</span> <span style="color:#f92672">=</span> <span style="color:#111">fund_value</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">[:</span><span style="color:#f92672">-</span><span style="color:#111">n</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">tolist</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">fund_return</span> <span style="color:#f92672">=</span> <span style="color:#111">fund_value_future</span> <span style="color:#f92672">/</span> <span style="color:#111">fund_value</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Replace infinity by NaN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">fund_return</span><span style="color:#f92672">.</span><span style="color:#111">replace</span><span style="color:#111">([</span><span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">inf</span><span style="color:#111">,</span> <span style="color:#f92672">-</span><span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">inf</span><span style="color:#111">],</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">nan</span><span style="color:#111">,</span> <span style="color:#111">inplace</span><span style="color:#f92672">=</span><span style="color:#00a8c8">True</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Delete all NaN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">fund_return</span> <span style="color:#f92672">=</span> <span style="color:#111">fund_return</span><span style="color:#f92672">.</span><span style="color:#111">dropna</span><span style="color:#111">(</span><span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#111">how</span><span style="color:#f92672">=</span><span style="color:#d88200">&#39;all&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">fund_return</span> <span style="color:#f92672">=</span> <span style="color:#111">fund_return</span><span style="color:#f92672">.</span><span style="color:#111">fillna</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">fund_return</span> <span style="color:#f92672">=</span> <span style="color:#111">fund_return</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#111">n</span><span style="color:#111">:,:]</span><span style="color:#f92672">.</span><span style="color:#111">reset_index</span><span style="color:#111">(</span><span style="color:#111">drop</span><span style="color:#f92672">=</span><span style="color:#00a8c8">True</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">fund_return</span><span style="color:#f92672">.</span><span style="color:#111">index</span> <span style="color:#f92672">=</span> <span style="color:#111">date</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#111">fund_return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Select the funds whose corresponding annual returns are not all zero as the sample space</span>
</span></span><span style="display:flex;"><span><span style="color:#111">fund_return</span> <span style="color:#f92672">=</span> <span style="color:#111">get_fund_return</span><span style="color:#111">(</span><span style="color:#ae81ff">4</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">fund_pool</span> <span style="color:#f92672">=</span> <span style="color:#111">list</span><span style="color:#111">(</span><span style="color:#111">fund_return</span><span style="color:#f92672">.</span><span style="color:#111">columns</span><span style="color:#111">[</span><span style="color:#111">fund_return</span><span style="color:#f92672">.</span><span style="color:#111">any</span><span style="color:#111">()])</span>
</span></span><span style="display:flex;"><span><span style="color:#111">fund_return</span> <span style="color:#f92672">=</span> <span style="color:#111">fund_return</span><span style="color:#f92672">.</span><span style="color:#111">filter</span><span style="color:#111">(</span><span style="color:#111">items</span><span style="color:#f92672">=</span><span style="color:#111">fund_pool</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">quarter_return</span> <span style="color:#f92672">=</span> <span style="color:#111">get_fund_return</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">filter</span><span style="color:#111">(</span><span style="color:#111">items</span><span style="color:#f92672">=</span><span style="color:#111">fund_pool</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[:</span><span style="color:#f92672">-</span><span style="color:#ae81ff">3</span><span style="color:#111">,</span> <span style="color:#111">:]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Read factor values</span>
</span></span><span style="display:flex;"><span><span style="color:#111">factor_csv_list</span> <span style="color:#f92672">=</span> <span style="color:#111">os</span><span style="color:#f92672">.</span><span style="color:#111">listdir</span><span style="color:#111">(</span><span style="color:#111">factor_path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">factor_csv_list</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#111">x</span> <span style="color:#00a8c8">for</span> <span style="color:#111">x</span> <span style="color:#f92672">in</span> <span style="color:#111">factor_csv_list</span> <span style="color:#00a8c8">if</span> <span style="color:#111">x</span><span style="color:#111">[</span><span style="color:#f92672">-</span><span style="color:#ae81ff">3</span><span style="color:#111">:]</span> <span style="color:#f92672">==</span> <span style="color:#d88200">&#34;csv&#34;</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span><span style="color:#111">factor_name_list</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#111">x</span><span style="color:#111">[:</span><span style="color:#f92672">-</span><span style="color:#ae81ff">4</span><span style="color:#111">]</span> <span style="color:#00a8c8">for</span> <span style="color:#111">x</span> <span style="color:#f92672">in</span> <span style="color:#111">factor_csv_list</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span><span style="color:#111">factor_df_list</span> <span style="color:#f92672">=</span> <span style="color:#111">[]</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">for</span> <span style="color:#111">i</span> <span style="color:#f92672">in</span> <span style="color:#111">range</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">factor_csv_list</span><span style="color:#111">)):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">file_path</span> <span style="color:#f92672">=</span> <span style="color:#111">os</span><span style="color:#f92672">.</span><span style="color:#111">path</span><span style="color:#f92672">.</span><span style="color:#111">join</span><span style="color:#111">(</span><span style="color:#111">factor_path</span><span style="color:#111">,</span> <span style="color:#111">factor_csv_list</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">tmp_factor</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">read_csv</span><span style="color:#111">(</span><span style="color:#111">file_path</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">tmp_factor</span><span style="color:#f92672">.</span><span style="color:#111">rename</span><span style="color:#111">(</span><span style="color:#111">columns</span><span style="color:#f92672">=</span><span style="color:#111">{</span><span style="color:#d88200">&#39;Unnamed: 0&#39;</span><span style="color:#111">:</span> <span style="color:#d88200">&#39;Date&#39;</span><span style="color:#111">},</span> <span style="color:#111">inplace</span><span style="color:#f92672">=</span><span style="color:#00a8c8">True</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">tmp_factor</span> <span style="color:#f92672">=</span> <span style="color:#111">tmp_factor</span><span style="color:#f92672">.</span><span style="color:#111">set_index</span><span style="color:#111">(</span><span style="color:#d88200">&#39;Date&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">tmp_factor</span> <span style="color:#f92672">=</span> <span style="color:#111">tmp_factor</span><span style="color:#f92672">.</span><span style="color:#111">filter</span><span style="color:#111">(</span><span style="color:#111">items</span><span style="color:#f92672">=</span><span style="color:#111">fund_pool</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">tmp_factor</span><span style="color:#f92672">.</span><span style="color:#111">fillna</span><span style="color:#111">(</span><span style="color:#ae81ff">0</span><span style="color:#111">,</span> <span style="color:#111">inplace</span><span style="color:#f92672">=</span><span style="color:#00a8c8">True</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">tmp_factor</span> <span style="color:#f92672">=</span> <span style="color:#111">tmp_factor</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">str</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">apply</span><span style="color:#111">(</span><span style="color:#00a8c8">lambda</span> <span style="color:#111">x</span><span style="color:#111">:</span> <span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">str</span><span style="color:#f92672">.</span><span style="color:#111">replace</span><span style="color:#111">(</span><span style="color:#d88200">&#34;,&#34;</span><span style="color:#111">,</span> <span style="color:#d88200">&#34;&#34;</span><span style="color:#111">))</span><span style="color:#f92672">.</span><span style="color:#111">astype</span><span style="color:#111">(</span><span style="color:#111">float</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#d88200">f</span><span style="color:#d88200">&#34;Readingï¼š</span><span style="color:#d88200">{</span><span style="color:#111">factor_name_list</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">]</span><span style="color:#d88200">}</span><span style="color:#d88200">&#34;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">factor_df_list</span><span style="color:#f92672">.</span><span style="color:#111">append</span><span style="color:#111">({</span><span style="color:#111">factor_name_list</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">]:</span> <span style="color:#111">tmp_factor</span><span style="color:#111">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># RankIC test</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">def</span> <span style="color:#75af00">get_RankIC</span><span style="color:#111">(</span><span style="color:#111">factor_name_list</span><span style="color:#111">,</span> <span style="color:#111">factor_df_list</span><span style="color:#111">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Return of next year</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">ICmean_list</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">zeros</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">factor_name_list</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">ICstd_list</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">zeros</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">factor_name_list</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">ICIR_list</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">zeros</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">factor_name_list</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">average_sample</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">zeros</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">factor_name_list</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#111">i</span> <span style="color:#f92672">in</span> <span style="color:#111">range</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">factor_name_list</span><span style="color:#111">)):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">factor_name</span> <span style="color:#f92672">=</span> <span style="color:#111">factor_name_list</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">factor_df</span> <span style="color:#f92672">=</span> <span style="color:#111">factor_df_list</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">][</span><span style="color:#111">factor_name</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">tmp_corr</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">zeros</span><span style="color:#111">(</span><span style="color:#111">factor_df</span><span style="color:#f92672">.</span><span style="color:#111">shape</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">sum_sample</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#111">day</span> <span style="color:#f92672">in</span> <span style="color:#111">range</span><span style="color:#111">(</span><span style="color:#111">factor_df</span><span style="color:#f92672">.</span><span style="color:#111">shape</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">return_series</span> <span style="color:#f92672">=</span> <span style="color:#111">fund_return</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#111">day</span><span style="color:#111">,</span> <span style="color:#111">:]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">factor_series</span> <span style="color:#f92672">=</span> <span style="color:#111">factor_df</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#111">day</span><span style="color:#111">,</span> <span style="color:#111">:]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Only keep non-zero columns</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">return_series_nonzero</span> <span style="color:#f92672">=</span> <span style="color:#111">return_series</span><span style="color:#111">[</span><span style="color:#111">return_series</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">factor_series_nonzero</span> <span style="color:#f92672">=</span> <span style="color:#111">factor_series</span><span style="color:#111">[</span><span style="color:#111">factor_series</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Only keep the shared parts</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">combine</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">merge</span><span style="color:#111">(</span><span style="color:#111">return_series_nonzero</span><span style="color:#111">,</span> <span style="color:#111">factor_series_nonzero</span><span style="color:#111">,</span> 
</span></span><span style="display:flex;"><span>                               <span style="color:#111">how</span><span style="color:#f92672">=</span><span style="color:#d88200">&#39;inner&#39;</span><span style="color:#111">,</span> <span style="color:#111">left_index</span><span style="color:#f92672">=</span><span style="color:#00a8c8">True</span><span style="color:#111">,</span> <span style="color:#111">right_index</span><span style="color:#f92672">=</span><span style="color:#00a8c8">True</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">return_series_common</span> <span style="color:#f92672">=</span> <span style="color:#111">combine</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[:,</span> <span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">factor_series_common</span> <span style="color:#f92672">=</span> <span style="color:#111">combine</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[:,</span> <span style="color:#ae81ff">1</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">np_return</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">array</span><span style="color:#111">(</span><span style="color:#111">return_series_common</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">np_factor</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">array</span><span style="color:#111">(</span><span style="color:#111">factor_series_common</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">num_sample</span> <span style="color:#f92672">=</span> <span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">np_return</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">sum_sample</span> <span style="color:#f92672">+=</span> <span style="color:#111">num_sample</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">rankic</span><span style="color:#111">,</span> <span style="color:#111">_</span> <span style="color:#f92672">=</span> <span style="color:#111">stats</span><span style="color:#f92672">.</span><span style="color:#111">spearmanr</span><span style="color:#111">(</span><span style="color:#111">np_return</span><span style="color:#111">,</span> <span style="color:#111">np_factor</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">tmp_corr</span><span style="color:#111">[</span><span style="color:#111">day</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#00a8c8">if</span> <span style="color:#111">math</span><span style="color:#f92672">.</span><span style="color:#111">isnan</span><span style="color:#111">(</span><span style="color:#111">rankic</span><span style="color:#111">)</span> <span style="color:#00a8c8">else</span> <span style="color:#111">rankic</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">average_sample</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">sum_sample</span> <span style="color:#f92672">/</span> <span style="color:#111">factor_df</span><span style="color:#f92672">.</span><span style="color:#111">shape</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">ICmean</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">tmp_corr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">ICstd</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">std</span><span style="color:#111">(</span><span style="color:#111">tmp_corr</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">ICIR</span> <span style="color:#f92672">=</span> <span style="color:#111">ICmean</span> <span style="color:#f92672">/</span> <span style="color:#111">ICstd</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">ICmean_list</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">ICmean</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">ICstd_list</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">ICstd</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">ICIR_list</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">ICIR</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">IC_summary</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">DataFrame</span><span style="color:#111">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">[</span><span style="color:#111">ICmean_list</span><span style="color:#111">,</span> <span style="color:#111">ICstd_list</span><span style="color:#111">,</span> <span style="color:#111">ICIR_list</span><span style="color:#111">,</span> <span style="color:#111">average_sample</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#111">IC_summary</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">def</span> <span style="color:#75af00">summarized_IC</span><span style="color:#111">(</span><span style="color:#111">factor_name_list</span><span style="color:#111">,</span> <span style="color:#111">factor_df_list</span><span style="color:#111">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">col_names</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#d88200">&#39;ICmean&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;ICstd&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;ICIR&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;AvgSample&#39;</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">IC_df</span> <span style="color:#f92672">=</span> <span style="color:#111">get_RankIC</span><span style="color:#111">(</span><span style="color:#111">factor_name_list</span><span style="color:#111">,</span> <span style="color:#111">factor_df_list</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">T</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">IC_df</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">col_names</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">IC_df</span><span style="color:#f92672">.</span><span style="color:#111">index</span> <span style="color:#f92672">=</span> <span style="color:#111">factor_name_list</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#111">IC_df</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">IC_df</span> <span style="color:#f92672">=</span> <span style="color:#111">summarized_IC</span><span style="color:#111">(</span><span style="color:#111">factor_name_list</span><span style="color:#111">,</span> <span style="color:#111">factor_df_list</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">IC_df</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">os</span><span style="color:#f92672">.</span><span style="color:#111">chdir</span><span style="color:#111">(</span><span style="color:#111">result_dir</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">IC_df</span><span style="color:#f92672">.</span><span style="color:#111">to_excel</span><span style="color:#111">(</span><span style="color:#d88200">&#34;RankIC.xlsx&#34;</span><span style="color:#111">)</span>
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">ICmean</th>
<th style="text-align:center">ICstd</th>
<th style="text-align:center">ICIR</th>
<th style="text-align:center">AvgSample</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">cisc_3(select_ability)</td>
<td style="text-align:center">0.089101</td>
<td style="text-align:center">0.169185</td>
<td style="text-align:center">0.526649</td>
<td style="text-align:center">1038.46</td>
</tr>
<tr>
<td style="text-align:center">cisc_3(fund_share)</td>
<td style="text-align:center">-0.096019</td>
<td style="text-align:center">0.091791</td>
<td style="text-align:center">-1.046066</td>
<td style="text-align:center">1279.50</td>
</tr>
<tr>
<td style="text-align:center">cisc_3(max_drawdown)</td>
<td style="text-align:center">-0.062207</td>
<td style="text-align:center">0.200550</td>
<td style="text-align:center">-0.310182</td>
<td style="text-align:center">1270.88</td>
</tr>
<tr>
<td style="text-align:center">cisc_3(institute_prop)</td>
<td style="text-align:center">0.077228</td>
<td style="text-align:center">0.117013</td>
<td style="text-align:center">0.659989</td>
<td style="text-align:center">1133.38</td>
</tr>
<tr>
<td style="text-align:center">cisc_3(annual_return)</td>
<td style="text-align:center">0.092428</td>
<td style="text-align:center">0.146760</td>
<td style="text-align:center">0.629790</td>
<td style="text-align:center">1045.56</td>
</tr>
</tbody>
</table>
<h3 id="portfolio-test">Portfolio test</h3>
<p>First of all, according to the factor value of the current period, the stocks are divided into five equal weight quantile portfolios, and the returns of the portfolios in the next period are denoted as \(R_1, R_2, \cdots, R_5\) We judge the effectiveness of the factor according to the return \(R_1\sim R_5\) of the long-short combination. If the return of the long-short combination is significantly different from zero, it indicates that the factor is effective. The higher the combination sharpe ratio, the more effective the factor is. However, it is worth noting that since the quantile array method only considers the returns of the two extreme combinations of long and short, and ignores the relevant information of the middle combinations of quantiles, there may be some limitations in the characterization of factor effectiveness.</p>
<p><img
  src="/img/cisc_3_7.png"
  alt="fig7"
  loading="lazy"
  decoding="async"
  class="full-width"
/>

</p>
<p>Add the following code to <code>main.py</code></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Quantile portfolio test</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">def</span> <span style="color:#75af00">quantile_test</span><span style="color:#111">(</span><span style="color:#111">IC_df</span><span style="color:#111">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">target_dict</span> <span style="color:#f92672">=</span> <span style="color:#111">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#111">i</span> <span style="color:#f92672">in</span> <span style="color:#111">range</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">factor_name_list</span><span style="color:#111">)):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Build a T*5 matrix</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">target</span> <span style="color:#f92672">=</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">zeros</span><span style="color:#111">([</span><span style="color:#111">quarter_return</span><span style="color:#f92672">.</span><span style="color:#111">shape</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">],</span> <span style="color:#ae81ff">5</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">factor_name</span> <span style="color:#f92672">=</span> <span style="color:#111">factor_name_list</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">factor_df</span> <span style="color:#f92672">=</span> <span style="color:#111">factor_df_list</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">][</span><span style="color:#111">factor_name</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">IC_mean</span> <span style="color:#f92672">=</span> <span style="color:#111">IC_df</span><span style="color:#f92672">.</span><span style="color:#111">loc</span><span style="color:#111">[</span><span style="color:#111">factor_name</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;ICmean&#39;</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#111">day</span> <span style="color:#f92672">in</span> <span style="color:#111">range</span><span style="color:#111">(</span><span style="color:#111">factor_df</span><span style="color:#f92672">.</span><span style="color:#111">shape</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">]):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">factor_value</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">DataFrame</span><span style="color:#111">({</span><span style="color:#d88200">&#39;factor_value&#39;</span><span style="color:#111">:</span> <span style="color:#111">factor_df</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#111">day</span><span style="color:#111">,</span> <span style="color:#111">:]</span><span style="color:#f92672">.</span><span style="color:#111">tolist</span><span style="color:#111">()})</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">factor_value</span> <span style="color:#f92672">=</span> <span style="color:#111">factor_value</span><span style="color:#111">[</span><span style="color:#111">factor_value</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">return_value</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">DataFrame</span><span style="color:#111">({</span><span style="color:#d88200">&#39;return_value&#39;</span><span style="color:#111">:</span> <span style="color:#111">quarter_return</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[</span><span style="color:#111">day</span><span style="color:#111">,</span> <span style="color:#111">:]</span><span style="color:#f92672">.</span><span style="color:#111">tolist</span><span style="color:#111">()})</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">return_value</span> <span style="color:#f92672">=</span> <span style="color:#111">return_value</span><span style="color:#111">[</span><span style="color:#111">return_value</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#111">IC_mean</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">quantile</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">qcut</span><span style="color:#111">(</span><span style="color:#111">factor_value</span><span style="color:#111">[</span><span style="color:#d88200">&#39;factor_value&#39;</span><span style="color:#111">],</span> <span style="color:#111">q</span><span style="color:#f92672">=</span><span style="color:#ae81ff">5</span><span style="color:#111">,</span> <span style="color:#111">labels</span><span style="color:#f92672">=</span><span style="color:#00a8c8">False</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">else</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">quantile</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">qcut</span><span style="color:#111">(</span><span style="color:#f92672">-</span><span style="color:#111">factor_value</span><span style="color:#111">[</span><span style="color:#d88200">&#39;factor_value&#39;</span><span style="color:#111">],</span> <span style="color:#111">q</span><span style="color:#f92672">=</span><span style="color:#ae81ff">5</span><span style="color:#111">,</span> <span style="color:#111">labels</span><span style="color:#f92672">=</span><span style="color:#00a8c8">False</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">quantile_df</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">concat</span><span style="color:#111">([</span><span style="color:#111">factor_value</span><span style="color:#111">[</span><span style="color:#d88200">&#39;factor_value&#39;</span><span style="color:#111">],</span> <span style="color:#111">return_value</span><span style="color:#111">[</span><span style="color:#d88200">&#39;return_value&#39;</span><span style="color:#111">],</span> <span style="color:#111">quantile</span><span style="color:#111">],</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">quantile_df</span><span style="color:#f92672">.</span><span style="color:#111">index</span> <span style="color:#f92672">=</span> <span style="color:#111">factor_df</span><span style="color:#f92672">.</span><span style="color:#111">columns</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">quantile_df</span><span style="color:#f92672">.</span><span style="color:#111">columns</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#111">factor_name</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;return_value&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;quantile&#39;</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">quantile_df</span><span style="color:#f92672">.</span><span style="color:#111">dropna</span><span style="color:#111">(</span><span style="color:#111">inplace</span><span style="color:#f92672">=</span><span style="color:#00a8c8">True</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">quantile_df</span> <span style="color:#f92672">=</span> <span style="color:#111">quantile_df</span><span style="color:#f92672">.</span><span style="color:#111">sort_values</span><span style="color:#111">(</span><span style="color:#111">by</span><span style="color:#f92672">=</span><span style="color:#d88200">&#39;quantile&#39;</span><span style="color:#111">,</span> <span style="color:#111">ascending</span><span style="color:#f92672">=</span><span style="color:#00a8c8">True</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">target</span><span style="color:#111">[</span><span style="color:#111">day</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">quantile_df</span><span style="color:#f92672">.</span><span style="color:#111">groupby</span><span style="color:#111">(</span><span style="color:#d88200">&#39;quantile&#39;</span><span style="color:#111">)[</span><span style="color:#d88200">&#39;return_value&#39;</span><span style="color:#111">]</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">()</span><span style="color:#f92672">.</span><span style="color:#111">tolist</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">tmp</span> <span style="color:#f92672">=</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">DataFrame</span><span style="color:#111">(</span><span style="color:#111">target</span><span style="color:#111">,</span> <span style="color:#111">columns</span><span style="color:#f92672">=</span><span style="color:#111">[</span><span style="color:#d88200">&#39;Group 1&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;Group 2&#39;</span><span style="color:#111">,</span>
</span></span><span style="display:flex;"><span>                                                       <span style="color:#d88200">&#39;Group 3&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;Group 4&#39;</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;Group 5&#39;</span><span style="color:#111">],</span> <span style="color:#111">index</span><span style="color:#f92672">=</span><span style="color:#111">quarter_return</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">target_dict</span><span style="color:#111">[</span><span style="color:#111">factor_name</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#111">tmp</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">cumprod</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#111">target_dict</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Plot portfolio test result</span>
</span></span><span style="display:flex;"><span><span style="color:#111">target</span> <span style="color:#f92672">=</span> <span style="color:#111">quantile_test</span><span style="color:#111">(</span><span style="color:#111">IC_df</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">for</span> <span style="color:#111">factor</span> <span style="color:#f92672">in</span> <span style="color:#111">factor_name_list</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">df</span> <span style="color:#f92672">=</span> <span style="color:#111">target</span><span style="color:#111">[</span><span style="color:#111">factor</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">dates</span> <span style="color:#f92672">=</span> <span style="color:#111">[</span><span style="color:#111">datetime</span><span style="color:#f92672">.</span><span style="color:#111">strptime</span><span style="color:#111">(</span><span style="color:#111">date_str</span><span style="color:#111">,</span> <span style="color:#d88200">&#39;%Y/%m/</span><span style="color:#d88200">%d</span><span style="color:#d88200">&#39;</span><span style="color:#111">)</span><span style="color:#f92672">.</span><span style="color:#111">date</span><span style="color:#111">()</span> <span style="color:#00a8c8">for</span> <span style="color:#111">date_str</span> <span style="color:#f92672">in</span> <span style="color:#111">df</span><span style="color:#f92672">.</span><span style="color:#111">index</span><span style="color:#f92672">.</span><span style="color:#111">tolist</span><span style="color:#111">()]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#111">group</span> <span style="color:#f92672">in</span> <span style="color:#111">df</span><span style="color:#f92672">.</span><span style="color:#111">columns</span><span style="color:#111">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">subplot</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">,</span> <span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">plot</span><span style="color:#111">(</span><span style="color:#111">dates</span><span style="color:#111">,</span> <span style="color:#111">df</span><span style="color:#111">[</span><span style="color:#111">group</span><span style="color:#111">],</span> <span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#111">group</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">gca</span><span style="color:#111">()</span><span style="color:#f92672">.</span><span style="color:#111">xaxis</span><span style="color:#f92672">.</span><span style="color:#111">set_major_formatter</span><span style="color:#111">(</span><span style="color:#111">mdates</span><span style="color:#f92672">.</span><span style="color:#111">DateFormatter</span><span style="color:#111">(</span><span style="color:#d88200">&#39;%Y&#39;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">subplot</span><span style="color:#111">(</span><span style="color:#ae81ff">1</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">,</span> <span style="color:#ae81ff">2</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">bar</span><span style="color:#111">(</span><span style="color:#111">group</span><span style="color:#111">,</span> <span style="color:#111">np</span><span style="color:#f92672">.</span><span style="color:#111">mean</span><span style="color:#111">(</span><span style="color:#111">df</span><span style="color:#111">[</span><span style="color:#111">group</span><span style="color:#111">]),</span> <span style="color:#111">label</span><span style="color:#f92672">=</span><span style="color:#111">group</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">legend</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">title</span><span style="color:#111">(</span><span style="color:#111">factor</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">xlabel</span><span style="color:#111">(</span><span style="color:#d88200">&#39;Date&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">ylabel</span><span style="color:#111">(</span><span style="color:#d88200">&#39;Return&#39;</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">plt</span><span style="color:#f92672">.</span><span style="color:#111">show</span><span style="color:#111">()</span>
</span></span></code></pre></div><p><img
  src="/img/cisc_3_2.png"
  alt="fig2"
  loading="lazy"
  decoding="async"
  class="full-width"
/>

</p>
<p><img
  src="/img/cisc_3_3.png"
  alt="fig3"
  loading="lazy"
  decoding="async"
  class="full-width"
/>

</p>
<p><img
  src="/img/cisc_3_4.png"
  alt="fig4"
  loading="lazy"
  decoding="async"
  class="full-width"
/>

</p>
<p><img
  src="/img/cisc_3_5.png"
  alt="fig5"
  loading="lazy"
  decoding="async"
  class="full-width"
/>

</p>
<p><img
  src="/img/cisc_3_6.png"
  alt="fig6"
  loading="lazy"
  decoding="async"
  class="full-width"
/>

</p>
<h3 id="factor-composition">Factor composition</h3>
<p>Add the following code to <code>main.py</code></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#00a8c8">def</span> <span style="color:#75af00">composite</span><span style="color:#111">(</span><span style="color:#111">IC_df</span><span style="color:#111">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">weight</span> <span style="color:#f92672">=</span> <span style="color:#111">IC_df</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[:,</span> <span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#f92672">/</span> <span style="color:#111">sum</span><span style="color:#111">(</span><span style="color:#111">IC_df</span><span style="color:#f92672">.</span><span style="color:#111">iloc</span><span style="color:#111">[:,</span> <span style="color:#ae81ff">0</span><span style="color:#111">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">norm_factor_list</span> <span style="color:#f92672">=</span> <span style="color:#111">[]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">for</span> <span style="color:#111">i</span> <span style="color:#f92672">in</span> <span style="color:#111">range</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">factor_name_list</span><span style="color:#111">)):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">factor_name</span> <span style="color:#f92672">=</span> <span style="color:#111">factor_name_list</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">factor_df</span> <span style="color:#f92672">=</span> <span style="color:#111">factor_df_list</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">][</span><span style="color:#111">factor_name</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">norm_factor</span> <span style="color:#f92672">=</span> <span style="color:#111">factor_df</span><span style="color:#f92672">.</span><span style="color:#111">copy</span><span style="color:#111">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">nonzero</span> <span style="color:#f92672">=</span> <span style="color:#111">norm_factor</span><span style="color:#111">[</span><span style="color:#111">norm_factor</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#111">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">norm_factor</span><span style="color:#111">[</span><span style="color:#111">norm_factor</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#111">nonzero</span><span style="color:#f92672">.</span><span style="color:#111">apply</span><span style="color:#111">(</span><span style="color:#00a8c8">lambda</span> <span style="color:#111">x</span><span style="color:#111">:</span> <span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">rank</span><span style="color:#111">(</span><span style="color:#111">pct</span><span style="color:#f92672">=</span><span style="color:#00a8c8">True</span><span style="color:#111">),</span> <span style="color:#111">axis</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">norm_factor_list</span><span style="color:#f92672">.</span><span style="color:#111">append</span><span style="color:#111">({</span><span style="color:#111">factor_name</span><span style="color:#111">:</span> <span style="color:#111">pd</span><span style="color:#f92672">.</span><span style="color:#111">DataFrame</span><span style="color:#111">(</span><span style="color:#111">norm_factor</span><span style="color:#111">,</span> <span style="color:#111">dtype</span><span style="color:#f92672">=</span><span style="color:#111">float</span><span style="color:#111">)})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">norm_df</span> <span style="color:#f92672">=</span> <span style="color:#111">sum</span><span style="color:#111">([</span><span style="color:#111">weight</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">]</span> <span style="color:#f92672">*</span> <span style="color:#111">norm_factor_list</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">][</span><span style="color:#111">factor_name_list</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">]]</span> <span style="color:#00a8c8">for</span> <span style="color:#111">i</span> <span style="color:#f92672">in</span> <span style="color:#111">range</span><span style="color:#111">(</span><span style="color:#111">len</span><span style="color:#111">(</span><span style="color:#111">factor_name_list</span><span style="color:#111">))])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">return</span> <span style="color:#111">norm_df</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#111">norm_df</span> <span style="color:#f92672">=</span> <span style="color:#111">composite</span><span style="color:#111">(</span><span style="color:#111">IC_df</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#111">composed</span> <span style="color:#f92672">=</span> <span style="color:#111">summarized_IC</span><span style="color:#111">([</span><span style="color:#d88200">&#39;Composite&#39;</span><span style="color:#111">],</span> <span style="color:#111">[{</span><span style="color:#d88200">&#39;Composite&#39;</span><span style="color:#111">:</span> <span style="color:#111">norm_df</span><span style="color:#111">}])</span>
</span></span><span style="display:flex;"><span><span style="color:#111">print</span><span style="color:#111">(</span><span style="color:#111">composed</span><span style="color:#111">)</span>
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">ICmean</th>
<th style="text-align:center">ICstd</th>
<th style="text-align:center">ICIR</th>
<th style="text-align:center">AvgSample</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Composite</td>
<td style="text-align:center">0.130709</td>
<td style="text-align:center">0.102025</td>
<td style="text-align:center">1.281154</td>
<td style="text-align:center">1280.56</td>
</tr>
</tbody>
</table>
<h3 id="reference">Reference</h3>
<ul>
<li><a href="/pdf/cisc_3_1.pdf">Research on heavy stock information under fund selection</a></li>
<li><a href="/pdf/cisc_3_2.pdf">Deep Analysis of Major Factors: Value Reproduction</a></li>
</ul>

      
      <div class="post-date">
        <span class="g time">February 2, 2024 </span> &#8729;
         
         <a href="http://localhost:1313/tech/tags/intern/">intern</a> <a href="http://localhost:1313/tech/tags/cisc/">cisc</a> <a href="http://localhost:1313/tech/tags/2024/">2024</a> <a href="http://localhost:1313/tech/tags/factor/">factor</a>
      </div>
      
    </section>
    
    
    <div id="comments">
      
<script src="https://utteranc.es/client.js"
    repo=FortuneQuant/tech
    issue-term="pathname"
    theme=github-light
    crossorigin="anonymous"
    async>
</script>


    </div>
    
    
  </div>
  </main>
  <script type="text/javascript" src="http://localhost:1313/tech/js/copy-code-button.js"></script>
  
    <link rel="stylesheet" href="http://localhost:1313/tech/css/copy-button.css">
</body>
</html>
